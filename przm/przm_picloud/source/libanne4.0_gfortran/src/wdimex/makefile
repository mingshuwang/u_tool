# Makefile for program - wdimex

include ../make.inc
#
# Usage:  make [BINDIR=path_to_install_to] [install] [| tee makeout]
#
# Examples:  make
#            make install BINDIR=/usr/opt/bin
#            make install BINDIR=$HOME/bin
#
# History:  95/12/05 kmflynn
#           99/07/30 kmflynn

FFVrsn  = $(FFUnix)         # Version FF[Unix, AIX]
LdA     = $(LdSunA)         # Ld[Unix, Sun]A
LdB     = $(LdSunB)         # Ld[Unix, Sun]B
Strip   = $(Strip_Y)        # strip (Strip_Y or Strip_N)

#*******************************************************************
#*****   Some things may need to be changed below this line.   *****
#*******************************************************************

# Compiler flags
#    C - check subranges and array bounds
#    u - default data type for undeclareds is undefined
#    g - generate source level symbolic debug information
#    O - optimization
# (NOTES: to generate debug code - set FFLAGS to Dbgf and
#                                  set Strip  to Strip_N
#            for production code - set FFLAGS to OptM and
#                                  set Strip to Strip_Y
DbgF   = -u -C -g
OptM   = -u -O

# compile options, use Unix for default
FFUnix =
FFAIX  = -qxlf77=leadzero        # force leading zero on output

# load options
#      use Unix for default, dynamic build
#      use Sun to link in Fortran library statically under Solaris
# Sun load options are very ugly.  After many tries, this is the
# best we could come up with for building a static version.  This
# combination works on our system.  Nor have we tested the dynamic
# link options.
LdUnixA =
LdUnixB =
LdSunA  = -nolib -Bstatic
LdSunB  = -lF77 -lM77 -lsunmath -lm -lcx -Bdynamic -lc

#load and link options combined
# LoadL  = $(LdA) $(LdB)
LoadL  =

# strip the symbol table, string table, and line number information
Strip_N =
Strip_Y = strip $@

# this description file uses the Bourne shell
SHELL = /bin/sh

#*******************************************************************
#***** You should not need to modify anything below this line. *****
#*******************************************************************

# library directories
LibDir  = ../../lib

program = wdimex

Objects = wdimex.o wdimez.o
Sadwdm  = cdrloc.inc cfbuff.inc
Libs    = $(LibDir)/wdmlib.a $(LibDir)/adwdmlib.a $(LibDir)/utillib.a

BINDIR  = ../../bin
binary  = ../../bin
binMake = $(binary)/$(program)
binInst = $(BINDIR)/$(program)
 
# Rules
all: includes first $(binMake) install
	@echo "***"
	@echo "*** Done making all for $(program), files are now up to date."
	@echo "***"

# program dependencies
$(binMake):  $(Objects) $(Libs)
	@echo "***"
	@echo "*** making $(binMake)"
	@echo "***"
	$(FC) $(Objects) $(Libs) $(LoadL) -o $@
	$(Strip)
first:
	@if [ ! -d $(binary) ]   ; then   \
	   mkdir $(binary)  ;             \
	   echo "*** Created $(binary)" ; \
	fi
install:
# Create directory for binary file, if necessary
	@if [ ! -d $(BINDIR) ]   ; then   \
	   mkdir $(BINDIR) ;              \
	   echo "*** Created $(BINDIR)" ; \
	fi
# Link executable to BINDIR if installing elsewhere
	@if [ ! -s $(binMake) ] ; then                                   \
	   echo "*** program $(binMake) does not exist," ;               \
	   echo "*** use one of the following commands to generate it:"; \
	   echo "***     make" ;  echo "***     make all" ;              \
	else                                                             \
	   if [ $(BINDIR) != $(binary) ] ; then                          \
	      rm -f $(binInst) ;                                         \
	      cd ../.. ; ln -s `pwd`/bin/$(program) $(binInst);          \
	      cd ./src/wdimex ;                                          \
	      chmod 0755 $(binInst) ;                                    \
	      echo "*** Program $(binInst) has been updated." ;          \
	   fi ;                                                          \
	fi
clean:
	@if [ $(BINDIR) != $(binary) ] ; then rm -f $(binInst) ; fi
	@rm -f *.o $(binMake)
	@echo "***"
	@echo "*** Removed files generated by make for $(program)."
	@echo "***"
includes:
	@for inc in $(Sadwdm) ; do                                          \
	   if [ -f $$inc ] ; then                                           \
	     if diff $$inc ../adwdm/$$inc ; then                            \
	        continue ;                                                  \
	     else                                                           \
	        echo "*** NOTICE:--different $$inc appended to ERROR.inc" ; \
	        echo "***" ;                                                \
	        echo "***          different $$inc, `date`" >> ERROR.inc ;  \
	        cat $$inc >> ERROR.inc ;                                    \
	        rm $$inc ;                                                  \
	        cp ../adwdm/$$inc . ;                                       \
	     fi ;                                                           \
	   else                                                             \
	     echo "*** NOTICE:--copying missing $$inc from ../adwdm" ;      \
	     cp ../adwdm/$$inc . ;                                          \
	   fi ;                                                             \
	done

# Define object file dependencies:
wdimex.o: fversn.inc cdrloc.inc cfbuff.inc

# end of make
